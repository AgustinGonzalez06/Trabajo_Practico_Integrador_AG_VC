<!DOCTYPE html>
<html lang="es">
  <%- include('../Partials/header', { titulo: 'Edicion de producto' }) %>

<body>


  <main class="formulario-producto">
    <h1>Editar producto</h1>

    <% if (errores && errores.length > 0) { %>
      <ul class="errores" style="color: red;">
        <% errores.forEach(err => { %>
          <li><%= err.msg %></li>
        <% }) %>
      </ul>
    <% } %>

    <form action="/admin/editar/<%= datos.id %>" method="POST" enctype="multipart/form-data">
      <label for="nombre">Nombre:</label>
      <input
        type="text"
        name="nombre"
        id="nombre"
        required
        minlength="3"
        maxlength="100"
        value="<%= datos?.nombre || '' %>"
      />

      <label for="precio">Precio:</label>
      <input
        type="number"
        name="precio"
        id="precio"
        required
        min="1"
        step="1"
        value="<%= datos?.precio || '' %>"
      />

      <label for="categoria">Categoría:</label>
      <select name="categoria" id="categoria" required>
        <option value="moneda" <%= datos?.categoria === 'moneda' ? 'selected' : '' %>>Moneda</option>
        <option value="skin" <%= datos?.categoria === 'skin' ? 'selected' : '' %>>Skin</option>
      </select>

      <label for="subcategoria">Subcategoría:</label>
      <select name="subcategoria" id="subcategoria" required>
        <% if (datos?.categoria === 'moneda') { %>
          <option value="vp" <%= datos?.subcategoria === 'vp' ? 'selected' : '' %>>VP</option>
          <option value="rp" <%= datos?.subcategoria === 'rp' ? 'selected' : '' %>>RP</option>
          <option value="radiant" <%= datos?.subcategoria === 'radiant' ? 'selected' : '' %>>Radiant</option>
        <% } else if (datos?.categoria === 'skin') { %>
          <option value="selecta" <%= datos?.subcategoria === 'selecta' ? 'selected' : '' %>>Selecta</option>
          <option value="deluxe" <%= datos?.subcategoria === 'deluxe' ? 'selected' : '' %>>Deluxe</option>
          <option value="premium" <%= datos?.subcategoria === 'premium' ? 'selected' : '' %>>Premium</option>
          <option value="ultra" <%= datos?.subcategoria === 'ultra' ? 'selected' : '' %>>Ultra</option>
          <option value="exclusive" <%= datos?.subcategoria === 'exclusive' ? 'selected' : '' %>>Exclusive</option>
        <% } else { %>
          <option value="" disabled selected>Seleccione categoría primero</option>
        <% } %>
      </select>

      <label>Imagen actual:</label><br />
      <% if (datos.img) { %>
        <img src="<%= datos.img %>" alt="Imagen actual" width="150" /><br />
      <% } else { %>
        <p>No hay imagen disponible.</p>
      <% } %>

      <label for="img">Subir nueva imagen (opcional):</label>
      <input type="file" name="img" id="img" accept="image/*" />

      <label for="activo">
        <input
          type="checkbox"
          name="activo"
          id="activo"
          <%= datos.activo ? 'checked' : '' %>
        />
        Activo
      </label>

      <label for="destacado">
        <input
          type="checkbox"
          name="destacado"
          id="destacado"
          <%= datos.destacado ? 'checked' : '' %>
        />
        Destacado
      </label>

      <br /><br />
      <button type="submit">Guardar cambios</button>
    </form>

    <a href="/admin/dashboard">⬅️ Volver al dashboard</a>
  </main>

  <%- include('../Partials/footer') %>
  <%- include('../Partials/scripts') %>

  <script>
    // Para actualizar dinámicamente las opciones de subcategoría según categoría seleccionada
    document.addEventListener('DOMContentLoaded', () => {
      const categoriaSelect = document.getElementById('categoria');
      const subcategoriaSelect = document.getElementById('subcategoria');

      const opcionesSubcategorias = {
        moneda: [
          { value: 'vp', text: 'VP' },
          { value: 'rp', text: 'RP' },
          { value: 'radiant', text: 'Radiant' },
        ],
        skin: [
          { value: 'selecta', text: 'Selecta' },
          { value: 'deluxe', text: 'Deluxe' },
          { value: 'premium', text: 'Premium' },
          { value: 'ultra', text: 'Ultra' },
          { value: 'exclusive', text: 'Exclusive' },
        ],
      };

      function actualizarSubcategorias() {
        const categoria = categoriaSelect.value;
        const actualesub = '<%= datos?.subcategoria || "" %>';

        // Limpiar opciones
        subcategoriaSelect.innerHTML = '';

        if (opcionesSubcategorias[categoria]) {
          opcionesSubcategorias[categoria].forEach(({ value, text }) => {
            const option = document.createElement('option');
            option.value = value;
            option.text = text;
            if (value === actualesub) option.selected = true;
            subcategoriaSelect.appendChild(option);
          });
          subcategoriaSelect.disabled = false;
        } else {
          const option = document.createElement('option');
          option.text = 'Seleccione categoría primero';
          option.disabled = true;
          option.selected = true;
          subcategoriaSelect.appendChild(option);
          subcategoriaSelect.disabled = true;
        }
      }

      categoriaSelect.addEventListener('change', actualizarSubcategorias);

      // Inicializar en carga
      actualizarSubcategorias();
    });
  </script>
</body>
</html>